version: '3.8'
networks:
  laboratory-1-network:
    driver: bridge

services:
  laboratory-1-db-1:
    image: cassandra:latest
    container_name: laboratory-1-db-1
    networks:
      - laboratory-1-network
    ports:
      - "9042:9042"
      - "7000:7000"
    environment: &cassandra_environment
      CASSANDRA_START_RPC: true
      CASSANDRA_RPC_ADDRESS: 0.0.0.0
      CASSANDRA_LISTEN_ADDRESS: auto
      CASSANDRA_CLUSTER_NAME: laboratory-1-cluster
      CASSANDRA_ENDPOINT_SNITCH: GossipingPropertyFileSnitch
      CASSANDRA_DC: laboratory-1-datacenter
      CASSANDRA_NUM_TOKENS: 256
      CASSANDRA_RACK: rack1
    restart:
      on-failure
    healthcheck: &healthcheck
      test: [ "CMD-SHELL", "nodetool status" ]
      interval: 1m
      start_period: 1m
      timeout: 10s
      retries: 10

#  laboratory-1-db-2:
#    image: cassandra:latest
#    container_name: laboratory-1-db-2
#    networks:
#      - laboratory-1-network
#    ports:
#      - "9043:9042"
#    environment: *cassandra_environment
#    restart:
#      on-failure
#    depends_on:
#      laboratory-1-db-1:
#        condition: service_healthy
#    healthcheck: *healthcheck

  laboratory-1-main:
    build:
      context: .
    container_name: laboratory-1-main
    image: laboratory-1-main
    networks:
      - laboratory-1-network
    ports:
      - "9090:9090"
    restart:
      on-failure
    environment:
      CASSANDRA_HOSTS: "laboratory-1-db-1"
      CASSANDRA_PORT: 9042
    depends_on:
      laboratory-1-db-1:
        condition: service_healthy
